##Code_Test_Project

#include <WiFi.h> 

// #define 15,2,0,4;
float temp = 0.0; // variable to store temperature value 
const char* ssid = "python1";  //No space in ssid name or password. Generate from mobile hot spot and then check if wifi scanner can see hotspot wifi
const char* password = "12345678";

int on_Time_in_sec = 0; //Initializing all the variables
int current_time = 0,difference=5;
bool light_detected = true;   //To on/off webpage
int led_number =1;
WiFiServer server(80);

String header;
#define uS_TO_S_FACTOR 1000000  
#define TIME_TO_SLEEP  30 //wake up after this time (sec)
RTC_DATA_ATTR int bootCount = 0;

int intensity  = 0;
int intensity_calib  = 0;
const int  POT_pin = A0;//vp=A0,34 on esp32 dev kit

//Pushbutton  to GPIO32 to wake up esp32 
#define BUTTON_PIN_BITMASK 0x100000000

 const int freq = 5000;
 const int ledChannel = 1;   
 const int ledChanne2 = 2;
 const int ledChanne3 = 3;
 const int ledChanne4 = 4;
 const int resolution = 8;
void setup(){
  Serial.begin(115200);
  delay(1000); 
  WiFi.mode(WIFI_STA);
  delay(100);
  Serial.print("Connecting to Wifi Network");
Serial.println(ssid);
WiFi.begin(ssid, password);
while (WiFi.status() != WL_CONNECTED) {delay(500);Serial.print(".");}
Serial.println("");
Serial.println("Successfully connected to WiFi.");
Serial.println("IP address of ESP32 is : ");
Serial.println(WiFi.localIP());
server.begin();
Serial.println("Server started");
on_Time_in_sec = millis()/1000;
  if (bootCount==0){Serial.println("Esp32 is starting up");
 ledcSetup(ledChannel, freq, resolution);// set pwm properties
 ledcSetup(ledChanne2, freq, resolution);
 ledcSetup(ledChanne3, freq, resolution);
 ledcSetup(ledChanne4, freq, resolution);
 ledcAttachPin(15, ledChannel);//attach these pins to pwm
 ledcAttachPin(2, ledChanne2);
 ledcAttachPin(0, ledChanne3);
 ledcAttachPin(4, ledChanne4);
  pinMode(15,OUTPUT);pinMode(0,OUTPUT);pinMode(2,OUTPUT);pinMode(4,OUTPUT);
  pinMode(16,INPUT);}//if first time powered up
  else{Serial.println("Esp32 is back from sleep");print_wakeup_reason();}
  
  ++bootCount;
  Serial.println("Boot number: " + String(bootCount));
  esp_sleep_enable_timer_wakeup(TIME_TO_SLEEP * uS_TO_S_FACTOR);//Set timer to wake-up automatically
  esp_sleep_enable_ext1_wakeup(BUTTON_PIN_BITMASK,ESP_EXT1_WAKEUP_ANY_HIGH);//set buttons gpio32,33 to wake up
  
              while(1)
              {
                if (digitalRead(16)==HIGH){Serial.println("Putton Pressed. Esp32 going to Sleep mode.");delay(1000);
                Serial.println("Wakeup ESP32 from sleep after " + String(TIME_TO_SLEEP) +" Seconds");TurnOff_All_Leds();
                esp_deep_sleep_start();}
                WebPage();
                   intensity_calib= analogRead(POT_pin);
                   intensity= map(intensity_calib, 0, 4095, 0, 255);
                  //if(intensity<=1){intensity=1;}
                  //if(intensity>=250){intensity=250;}
                  Serial.println("Led's intensity :  "+String(intensity));
                  ledcWrite(ledChannel,intensity);ledcWrite(ledChanne2,0);ledcWrite(ledChanne3,0);ledcWrite(ledChanne4,0);delay(300);//leds blinking sequence
                  ledcWrite(ledChannel,0);ledcWrite(ledChanne2,intensity);ledcWrite(ledChanne3,0);ledcWrite(ledChanne4,0);delay(300);
                  ledcWrite(ledChannel,0);ledcWrite(ledChanne2,0);ledcWrite(ledChanne3,intensity);ledcWrite(ledChanne4,0);delay(300);
                  ledcWrite(ledChannel,0);ledcWrite(ledChanne2,0);ledcWrite(ledChanne3,0);ledcWrite(ledChanne4,intensity);delay(300);

//                  ledcWrite(ledChannel,intensity);ledcWrite(ledChanne2,intensity);ledcWrite(ledChanne3,0);ledcWrite(ledChanne4,0);delay(300);
//                  ledcWrite(ledChannel,0);ledcWrite(ledChanne2,0);ledcWrite(ledChanne3,0);ledcWrite(ledChanne4,0);delay(300);
                //TurnOff_All_Leds();
              
              }
  
          }

void loop(){}

void print_wakeup_reason(){
  esp_sleep_wakeup_cause_t wakeup_reason;
  wakeup_reason = esp_sleep_get_wakeup_cause();
  switch(wakeup_reason)
  {
    case 1  : Serial.println("Wakecausedup  by external signal using RTC_IO"); break;
    case 2  : Serial.println("Wakeup caused by external signal using RTC_CNTL"); break;
    case 3  : Serial.println("Wakeup caused by timer"); break;
    case 4  : Serial.println("Wakeup caused by touchpad"); break;
    case 5  : Serial.println("Wakeup caused by ULP program"); break;
    default : Serial.println("Wakeup was not caused by deep sleep"); break;
  }
}
void TurnOff_All_Leds()
{
  ledcWrite(ledChannel,0);ledcWrite(ledChanne2,0);ledcWrite(ledChanne3,0);ledcWrite(ledChanne4,0);
}
void WebPage()
{
  current_time =millis()/1000;
difference = current_time - on_Time_in_sec;
if (light_detected==false){
Serial.print("\t ON_Time: ");
Serial.println(difference);
Serial.println(WiFi.localIP());
}
else{
  Serial.println("\t Web Page Not Available ");
  }
//server.begin(); 
Serial.println("*******************************************");
// This line checks if web client is available or not
WiFiClient client = server.available();
// if client is available 'if' condition becomes true
if (client) 
{ 
Serial.println("Web Client connected ");   //print on serial monitor
String request = client.readStringUntil('\r'); // wait untill http get request ends
client.println("HTTP/1.1 200 OK");
client.println("Content-type:text/html");
client.println("Connection: close");
client.println();

if (light_detected ==false){
// This part send HTML page to web client 
// HTML page contains temperature values 
client.println("<!DOCTYPE html>\n");
client.println("<html>\n");
client.println("<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n");
client.println("<body>\n");
client.println("<h1>WEB SERVER TIME DISPLAYER</h1>\n");
client.println("<p style=\"color:red\">ON_TIME :\"");
client.println(difference);
client.println("sec</p>\n");
client.println("</body></html>"); 
client.println();
Serial.println("Client disconnected.");
Serial.println("");
}
else
{
  client.println("<h1>Web Page Not Available</h1>\n");
  Serial.println("Web Page Not Available"); 
  }
}

}
